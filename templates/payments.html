{% extends "base.html" %}

{% block title %}Payments - Mazin Yahia Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Payments Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card animate-on-scroll">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="text-gradient mb-2">
                            <i class="fas fa-credit-card"></i> Payment Management
                        </h1>
                        <p class="text-secondary lead mb-0">
                            Secure payment processing with Stripe integration and comprehensive transaction tracking.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-futuristic" onclick="exportPayments()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            {% if current_user.role.value == 'admin' %}
                            <button class="btn btn-outline-futuristic" onclick="generateInvoice()">
                                <i class="fas fa-file-invoice"></i> Invoice
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Stats -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3 animate-child">
            <div class="stat-card">
                <div class="stat-number">${{ payments|selectattr('status.value', 'equalto', 'completed')|map(attribute='amount')|sum|round(2) }}</div>
                <div class="stat-label">Total Paid</div>
                <div class="mt-2">
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 animate-child">
            <div class="stat-card">
                <div class="stat-number">${{ payments|selectattr('status.value', 'equalto', 'pending')|map(attribute='amount')|sum|round(2) }}</div>
                <div class="stat-label">Pending</div>
                <div class="mt-2">
                    <i class="fas fa-clock fa-2x text-warning"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 animate-child">
            <div class="stat-card">
                <div class="stat-number">{{ payments|selectattr('status.value', 'equalto', 'completed')|list|length }}</div>
                <div class="stat-label">Transactions</div>
                <div class="mt-2">
                    <i class="fas fa-exchange-alt fa-2x text-info"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 animate-child">
            <div class="stat-card">
                <div class="stat-number">{{ payments|selectattr('status.value', 'equalto', 'failed')|list|length }}</div>
                <div class="stat-label">Failed</div>
                <div class="mt-2">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-futuristic btn-sm active" onclick="filterPayments('all')">
                                All Payments
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterPayments('pending')">
                                Pending
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterPayments('completed')">
                                Completed
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterPayments('failed')">
                                Failed
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterPayments('refunded')">
                                Refunded
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-secondary">
                                <i class="fas fa-search text-primary"></i>
                            </span>
                            <input type="text" class="form-control form-control-futuristic" 
                                   placeholder="Search payments..." onkeyup="searchPayments(this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payments List -->
    {% if payments %}
        <div class="row">
            <div class="col-12">
                <div class="glass-card animate-on-scroll">
                    <div class="table-responsive">
                        <table class="table table-futuristic">
                            <thead>
                                <tr>
                                    <th>Payment ID</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payments-tbody">
                                {% for payment in payments %}
                                <tr class="payment-row" 
                                    data-status="{{ payment.status.value }}" 
                                    data-description="{{ payment.description.lower() if payment.description else '' }}">
                                    <td>
                                        <div>
                                            <strong class="text-primary">#{{ payment.id }}</strong>
                                            {% if payment.stripe_payment_intent_id %}
                                                <small class="d-block text-muted">{{ payment.stripe_payment_intent_id[:20] }}...</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ payment.description or 'Payment #' + payment.id|string }}</strong>
                                            {% if payment.project_id %}
                                                <small class="d-block text-muted">
                                                    <i class="fas fa-project-diagram"></i> Project Payment
                                                </small>
                                            {% elif payment.contract_id %}
                                                <small class="d-block text-muted">
                                                    <i class="fas fa-file-contract"></i> Contract Payment
                                                </small>
                                            {% elif payment.milestone_id %}
                                                <small class="d-block text-muted">
                                                    <i class="fas fa-flag"></i> Milestone Payment
                                                </small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <strong class="text-success">${{ "%.2f"|format(payment.amount) }}</strong>
                                        <small class="d-block text-muted">{{ payment.currency }}</small>
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ payment.status.value }}">
                                            {{ payment.status.value.replace('_', ' ').title() }}
                                        </span>
                                        {% if payment.paid_at %}
                                            <small class="d-block text-success">
                                                Paid: {{ payment.paid_at.strftime('%m/%d/%Y %H:%M') }}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span>{{ payment.created_at.strftime('%m/%d/%Y') }}</span>
                                        <small class="d-block text-muted">{{ payment.created_at.strftime('%H:%M') }}</small>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                    data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu glass-card">
                                                <li><a class="dropdown-item" href="#" onclick="viewPayment({{ payment.id }})">
                                                    <i class="fas fa-eye"></i> View Details
                                                </a></li>
                                                {% if payment.status.value == 'pending' %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('main.create_checkout_session') }}" style="display: inline;">
                                                        <input type="hidden" name="payment_id" value="{{ payment.id }}">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="fas fa-credit-card"></i> Pay Now
                                                        </button>
                                                    </form>
                                                </li>
                                                {% endif %}
                                                {% if payment.status.value == 'completed' %}
                                                <li><a class="dropdown-item" href="#" onclick="downloadReceipt({{ payment.id }})">
                                                    <i class="fas fa-receipt"></i> Download Receipt
                                                </a></li>
                                                {% endif %}
                                                {% if current_user.role.value == 'admin' and payment.status.value == 'completed' %}
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-warning" href="#" onclick="refundPayment({{ payment.id }})">
                                                    <i class="fas fa-undo"></i> Process Refund
                                                </a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="row">
            <div class="col-12">
                <div class="glass-card text-center py-5 animate-on-scroll">
                    <i class="fas fa-credit-card fa-4x text-muted mb-4"></i>
                    <h3 class="text-muted mb-3">No payments found</h3>
                    <p class="text-secondary lead mb-4">
                        Payment history will appear here once transactions are processed.
                    </p>
                    <div class="d-flex gap-3 justify-content-center">
                        <a href="{{ url_for('main.projects') }}" class="btn btn-futuristic">
                            <i class="fas fa-project-diagram"></i> View Projects
                        </a>
                        <a href="{{ url_for('main.contracts') }}" class="btn btn-outline-futuristic">
                            <i class="fas fa-file-contract"></i> View Contracts
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-gradient">Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="paymentModalBody">
                <!-- Payment details will be loaded here -->
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-outline-futuristic" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.text-gradient {
    background: linear-gradient(45deg, var(--primary-green), var(--primary-blue), var(--primary-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.payment-row {
    transition: all 0.3s ease;
}

.payment-row.hidden {
    display: none;
}

.status-pending { background: rgba(255, 179, 71, 0.2); color: var(--warning-color); border: 1px solid var(--warning-color); }
.status-completed { background: rgba(0, 255, 136, 0.2); color: var(--success-color); border: 1px solid var(--success-color); }
.status-failed { background: rgba(255, 71, 87, 0.2); color: var(--error-color); border: 1px solid var(--error-color); }
.status-refunded { background: rgba(0, 153, 255, 0.2); color: var(--info-color); border: 1px solid var(--info-color); }

.btn-outline-futuristic.active {
    background: linear-gradient(45deg, var(--primary-green), var(--primary-blue));
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function filterPayments(status) {
    const rows = document.querySelectorAll('.payment-row');
    const buttons = document.querySelectorAll('.btn-outline-futuristic.btn-sm');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter rows
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

function searchPayments(query) {
    const rows = document.querySelectorAll('.payment-row');
    const searchTerm = query.toLowerCase();
    
    rows.forEach(row => {
        const description = row.dataset.description;
        
        if (description.includes(searchTerm)) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

function viewPayment(paymentId) {
    // Mock payment data - in real implementation, fetch from server
    const paymentData = {
        id: paymentId,
        amount: 150.00,
        currency: 'USD',
        status: 'completed',
        description: 'Web Development Payment',
        stripe_id: 'pi_1234567890',
        created: '2025-01-15',
        paid: '2025-01-15'
    };
    
    const modalBody = document.getElementById('paymentModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="glass-card mb-3">
                    <h6 class="text-secondary mb-2">Payment Information</h6>
                    <div class="mb-2">
                        <small class="text-muted">Payment ID</small>
                        <div class="text-primary">#${paymentData.id}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Description</small>
                        <div>${paymentData.description}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Amount</small>
                        <div class="text-success h5">$${paymentData.amount.toFixed(2)} ${paymentData.currency}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card mb-3">
                    <h6 class="text-secondary mb-2">Transaction Details</h6>
                    <div class="mb-2">
                        <small class="text-muted">Status</small>
                        <div><span class="status-badge status-${paymentData.status}">${paymentData.status.toUpperCase()}</span></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Stripe ID</small>
                        <div class="text-muted small">${paymentData.stripe_id}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Created</small>
                        <div>${paymentData.created}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Paid</small>
                        <div class="text-success">${paymentData.paid}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function downloadReceipt(paymentId) {
    showNotification('Preparing receipt download...', 'info');
    // Implementation for downloading receipt
}

function refundPayment(paymentId) {
    if (confirm('Are you sure you want to process a refund for this payment?')) {
        showNotification('Processing refund...', 'warning');
        // Implementation for processing refund
        setTimeout(() => {
            showNotification('Refund processed successfully', 'success');
            window.location.reload();
        }, 2000);
    }
}

function exportPayments() {
    showNotification('Preparing payments export...', 'info');
    // Implementation for exporting payments
}

function generateInvoice() {
    showNotification('Opening invoice generator...', 'info');
    // Implementation for generating invoice
}
</script>
{% endblock %}
