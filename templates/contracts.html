{% extends "base.html" %}

{% block title %}Contracts - Mazin Yahia Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Contracts Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card animate-on-scroll">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="text-gradient mb-2">
                            <i class="fas fa-file-contract"></i> Contract Management
                        </h1>
                        <p class="text-secondary lead mb-0">
                            Manage all your digital contracts with advanced signing and tracking capabilities.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        {% if current_user.role.value == 'admin' %}
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-futuristic" onclick="createContract()">
                                <i class="fas fa-plus"></i> New Contract
                            </button>
                            <button class="btn btn-outline-futuristic" onclick="exportContracts()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-futuristic btn-sm active" onclick="filterContracts('all')">
                                All Contracts
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterContracts('draft')">
                                Draft
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterContracts('sent')">
                                Sent
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterContracts('signed')">
                                Signed
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterContracts('active')">
                                Active
                            </button>
                            <button class="btn btn-outline-futuristic btn-sm" onclick="filterContracts('completed')">
                                Completed
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-secondary">
                                <i class="fas fa-search text-primary"></i>
                            </span>
                            <input type="text" class="form-control form-control-futuristic" 
                                   placeholder="Search contracts..." onkeyup="searchContracts(this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contracts List -->
    {% if contracts %}
        <div class="row">
            <div class="col-12">
                <div class="glass-card animate-on-scroll">
                    <div class="table-responsive">
                        <table class="table table-futuristic">
                            <thead>
                                <tr>
                                    <th>Contract</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contracts-tbody">
                                {% for contract in contracts %}
                                <tr class="contract-row" 
                                    data-status="{{ contract.status.value }}" 
                                    data-title="{{ contract.title.lower() }}"
                                    data-client="{{ contract.client.get_full_name().lower() }}">
                                    <td>
                                        <div>
                                            <strong class="text-primary">{{ contract.title }}</strong>
                                            <small class="d-block text-muted">{{ contract.content[:60] }}...</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if contract.client.profile_image %}
                                                <img src="{{ url_for('main.uploaded_file', filename=contract.client.profile_image) }}" 
                                                     class="rounded-circle me-2" width="32" height="32">
                                            {% else %}
                                                <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px;">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <strong>{{ contract.client.get_full_name() }}</strong>
                                                <small class="d-block text-muted">{{ contract.client.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong class="text-success">${{ "%.2f"|format(contract.total_amount) }}</strong>
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ contract.status.value }}">
                                            {{ contract.status.value.replace('_', ' ').title() }}
                                        </span>
                                        {% if contract.expires_at and contract.expires_at < moment().utcnow() %}
                                            <small class="d-block text-danger">
                                                <i class="fas fa-exclamation-triangle"></i> Expired
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span>{{ contract.created_at.strftime('%m/%d/%Y') }}</span>
                                        {% if contract.signed_at %}
                                            <small class="d-block text-success">
                                                Signed: {{ contract.signed_at.strftime('%m/%d/%Y') }}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                    data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu glass-card">
                                                <li><a class="dropdown-item" href="#" onclick="viewContract({{ contract.id }})">
                                                    <i class="fas fa-eye"></i> View Details
                                                </a></li>
                                                {% if contract.status.value == 'draft' and current_user.role.value == 'admin' %}
                                                <li><a class="dropdown-item" href="#" onclick="editContract({{ contract.id }})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="sendContract({{ contract.id }})">
                                                    <i class="fas fa-paper-plane"></i> Send to Client
                                                </a></li>
                                                {% endif %}
                                                {% if contract.status.value == 'sent' and current_user.id == contract.client_id %}
                                                <li><a class="dropdown-item" href="#" onclick="signContract({{ contract.id }})">
                                                    <i class="fas fa-signature"></i> Sign Contract
                                                </a></li>
                                                {% endif %}
                                                <li><a class="dropdown-item" href="#" onclick="downloadContract({{ contract.id }})">
                                                    <i class="fas fa-download"></i> Download PDF
                                                </a></li>
                                                {% if current_user.role.value == 'admin' %}
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteContract({{ contract.id }})">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="row">
            <div class="col-12">
                <div class="glass-card text-center py-5 animate-on-scroll">
                    <i class="fas fa-file-contract fa-4x text-muted mb-4"></i>
                    <h3 class="text-muted mb-3">No contracts found</h3>
                    <p class="text-secondary lead mb-4">
                        {% if current_user.role.value == 'admin' %}
                            Start creating digital contracts to manage your client agreements securely.
                        {% else %}
                            Your contracts will appear here once they are created by the admin.
                        {% endif %}
                    </p>
                    {% if current_user.role.value == 'admin' %}
                    <button class="btn btn-futuristic btn-lg" onclick="createContract()">
                        <i class="fas fa-plus"></i> Create First Contract
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Contract Details Modal -->
<div class="modal fade" id="contractModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-gradient">Contract Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contractModalBody">
                <!-- Contract details will be loaded here -->
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-outline-futuristic" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-futuristic" id="contractActionBtn" style="display: none;">
                    Action
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Digital Signature Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-gradient">Digital Signature</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-signature fa-3x text-primary mb-3"></i>
                    <h5>Sign Contract Digitally</h5>
                    <p class="text-secondary">By signing, you agree to the terms and conditions outlined in this contract.</p>
                </div>
                
                <div class="mb-3">
                    <label for="signatureName" class="form-label-futuristic">Full Legal Name</label>
                    <input type="text" class="form-control form-control-futuristic" 
                           id="signatureName" placeholder="Enter your full legal name">
                </div>
                
                <div class="mb-3">
                    <label for="signatureDate" class="form-label-futuristic">Date</label>
                    <input type="date" class="form-control form-control-futuristic" 
                           id="signatureDate" value="{{ moment().utcnow().strftime('%Y-%m-%d') }}" readonly>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="signatureConfirm" required>
                    <label class="form-check-label text-secondary" for="signatureConfirm">
                        I confirm that I have read, understood, and agree to all terms and conditions in this contract.
                    </label>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-outline-futuristic" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-futuristic" onclick="submitSignature()">
                    <i class="fas fa-signature"></i> Sign Contract
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.text-gradient {
    background: linear-gradient(45deg, var(--primary-green), var(--primary-blue), var(--primary-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.contract-row {
    transition: all 0.3s ease;
}

.contract-row.hidden {
    display: none;
}

.status-draft { background: rgba(108, 117, 125, 0.2); color: var(--text-muted); border: 1px solid var(--text-muted); }
.status-sent { background: rgba(255, 179, 71, 0.2); color: var(--warning-color); border: 1px solid var(--warning-color); }
.status-signed { background: rgba(0, 153, 255, 0.2); color: var(--info-color); border: 1px solid var(--info-color); }
.status-active { background: rgba(0, 255, 136, 0.2); color: var(--success-color); border: 1px solid var(--success-color); }
.status-completed { background: rgba(0, 153, 255, 0.2); color: var(--info-color); border: 1px solid var(--info-color); }
.status-expired { background: rgba(255, 71, 87, 0.2); color: var(--error-color); border: 1px solid var(--error-color); }

.btn-outline-futuristic.active {
    background: linear-gradient(45deg, var(--primary-green), var(--primary-blue));
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentContractId = null;

function filterContracts(status) {
    const rows = document.querySelectorAll('.contract-row');
    const buttons = document.querySelectorAll('.btn-outline-futuristic.btn-sm');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter rows
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

function searchContracts(query) {
    const rows = document.querySelectorAll('.contract-row');
    const searchTerm = query.toLowerCase();
    
    rows.forEach(row => {
        const title = row.dataset.title;
        const client = row.dataset.client;
        
        if (title.includes(searchTerm) || client.includes(searchTerm)) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

function viewContract(contractId) {
    currentContractId = contractId;
    
    // Mock contract data - in real implementation, fetch from server
    const contractData = {
        title: "Web Development Contract",
        content: "This is a comprehensive web development contract...",
        terms: "Payment terms, delivery schedule, etc...",
        amount: 5000.00,
        status: "signed",
        client: "John Doe",
        created: "2025-01-01"
    };
    
    const modalBody = document.getElementById('contractModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h4 class="text-gradient mb-3">${contractData.title}</h4>
                <div class="glass-card mb-3">
                    <h6 class="text-secondary mb-2">Contract Content</h6>
                    <p class="text-muted">${contractData.content}</p>
                </div>
                <div class="glass-card">
                    <h6 class="text-secondary mb-2">Terms & Conditions</h6>
                    <p class="text-muted">${contractData.terms}</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card">
                    <h6 class="text-secondary mb-3">Contract Summary</h6>
                    <div class="mb-2">
                        <small class="text-muted">Total Amount</small>
                        <div class="text-success h5">$${contractData.amount.toFixed(2)}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Status</small>
                        <div><span class="status-badge status-${contractData.status}">${contractData.status.replace('_', ' ').toUpperCase()}</span></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Client</small>
                        <div class="text-primary">${contractData.client}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Created</small>
                        <div>${contractData.created}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('contractModal'));
    modal.show();
}

function editContract(contractId) {
    showNotification('Opening contract editor...', 'info');
    // Implementation for editing contract
}

function sendContract(contractId) {
    if (confirm('Send this contract to the client?')) {
        showNotification('Contract sent to client successfully!', 'success');
        // Implementation for sending contract
        setTimeout(() => window.location.reload(), 1000);
    }
}

function signContract(contractId) {
    currentContractId = contractId;
    const modal = new bootstrap.Modal(document.getElementById('signatureModal'));
    modal.show();
}

function submitSignature() {
    const name = document.getElementById('signatureName').value;
    const confirmed = document.getElementById('signatureConfirm').checked;
    
    if (!name || !confirmed) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    showNotification('Contract signed successfully!', 'success');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('signatureModal'));
    modal.hide();
    
    setTimeout(() => window.location.reload(), 1000);
}

function downloadContract(contractId) {
    showNotification('Preparing contract download...', 'info');
    // Implementation for downloading contract PDF
}

function createContract() {
    showNotification('Opening contract creator...', 'info');
    // Implementation for creating new contract
}

function deleteContract(contractId) {
    if (confirm('Are you sure you want to delete this contract? This action cannot be undone.')) {
        showNotification('Contract deleted successfully', 'success');
        // Implementation for deleting contract
        setTimeout(() => window.location.reload(), 1000);
    }
}

function exportContracts() {
    showNotification('Preparing contracts export...', 'info');
    // Implementation for exporting contracts
}
</script>
{% endblock %}
